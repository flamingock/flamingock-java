package io.mongock.runner.springboot.config;

import io.mongock.api.config.MongockConfiguration;
import io.mongock.driver.api.driver.ConnectionDriver;
import io.mongock.runner.springboot.MongockScanPackage;
import io.mongock.runner.springboot.MongockSpringboot;
import io.mongock.runner.springboot.RunnerSpringbootBuilder;
import io.mongock.runner.springboot.base.builder.SpringApplicationBean;
import io.mongock.runner.springboot.base.config.MongockContextBase;
import org.springframework.boot.autoconfigure.condition.ConditionalOnExpression;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.context.annotation.Bean;
import org.springframework.core.annotation.AnnotationUtils;

import java.util.Arrays;

@ConditionalOnExpression("${mongock.enabled:true}")
public class MongockContext extends MongockContextBase<MongockConfiguration> {

  @Bean
  public SpringApplicationBean getBuilder(ConnectionDriver connectionDriver,
                                          MongockConfiguration springConfiguration,
                                          ApplicationContext springContext,
                                          ApplicationEventPublisher applicationEventPublisher) {

    RunnerSpringbootBuilder builder = MongockSpringboot.builder()
        .setDriver(connectionDriver)
        .setConfig(springConfiguration)
        .setSpringContext(springContext)
        .setEventPublisher(applicationEventPublisher);

    addPackagesFromAnnotationMongockScanPackage(builder, springContext);

    return builder;
  }

  /**
   * Configures the packages that will be scanned to find Mongock migrations
   * based on the @MongockScanPackage annotation found in Spring beans.
   */
  private void configureMigrationPackagesFromAnnotation(RunnerSpringbootBuilder builder,
                                                           ApplicationContext springContext) {

    // Finds all beans that have the @MongockScanPackage annotation
    for (Object bean : springContext.getBeansWithAnnotation(MongockScanPackage.class).values()) {
      Class<?> annotatedClass = bean.getClass();
      MongockScanPackage scanAnnotation = AnnotationUtils.findAnnotation(annotatedClass, MongockScanPackage.class);

      if (scanAnnotation != null) {
        String[] basePackages = scanAnnotation.basePackages();
        builder.addMigrationScanPackages(Arrays.asList(basePackages));
      }
    }
  }
}
